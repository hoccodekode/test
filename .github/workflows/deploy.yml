name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    # ------------------------------------
    # 1. BUILD FRONTEND (Fix lỗi ESLint)
    # ------------------------------------
    - name: Setup Node.js environment
      uses: actions/setup-node@v3
      with:
        node-version: '18' # Hoặc phiên bản Node.js bạn dùng cho React

    - name: Install Frontend dependencies
      run: npm install
      working-directory: ./frontend 

    - name: Build Frontend
      run: npm run build
      working-directory: ./frontend
      env:
        NODE_ENV: production
        CI: false # <--- ĐIỀU NÀY BUỘC BUILD THÀNH CÔNG DÙ CÓ CẢNH BÁO
        
    # ------------------------------------
    # 2. DEPLOY TO VPS (Fix lỗi SSH)
    # ------------------------------------
    - name: Deploy to VPS (Frontend & Backend)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        key_algorithm: 'ssh-rsa' # Khắc phục lỗi Handshake
        source: "./*"
        target: "/var/www/windshop"
    
    # ------------------------------------
    # 3. RELOAD SERVICES
    # ------------------------------------
    - name: Restart Backend and Reload Nginx
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        key_algorithm: 'ssh-rsa'
        script: |
          # Vào thư mục Backend để kích hoạt lại venv (nếu có thay đổi requirements)
          cd /var/www/windshop/backend
          /var/www/windshop/backend/venv/bin/pip install -r requirements.txt
          
          # Khởi động lại Gunicorn (Backend FastAPI)
          sudo systemctl restart windshop_backend
          
          # Reload Nginx
          sudo systemctl reload nginx
          
          echo "Deployment và khởi động lại dịch vụ hoàn tất."