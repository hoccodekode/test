name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    # ------------------------------------
    # 1. BUILD FRONTEND (Tạo thư mục 'build')
    # ------------------------------------
    - name: Setup Node.js environment
      uses: actions/setup-node@v3
      with:
        node-version: '18' # Hoặc phiên bản Node.js bạn dùng cho React

    - name: Install Frontend dependencies
      run: npm install
      working-directory: ./frontend 

    - name: Build Frontend
      run: npm run build
      working-directory: ./frontend
      env:
        # Đảm bảo process.env.NODE_ENV là production (nếu cần)
        NODE_ENV: production
        CI: false # <--- THÊM DÒNG NÀY ĐỂ BUỘC BUILD HOÀN THÀNH DÙ CÓ WARNING
    # ------------------------------------
    # 2. DEPLOY TO VPS (Khắc phục lỗi SSH)
    # ------------------------------------
    - name: Deploy to VPS (Frontend & Backend)
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # THAM SỐ KHẮC PHỤC LỖI SSH HANDSHAKE
        key_algorithm: 'ssh-rsa' 
        # Triển khai toàn bộ (Frontend đã build, Backend, .gitignore,...)
        source: "./*"
        target: "/var/www/windshop"
    
    # ------------------------------------
    # 3. RELOAD SERVICES (Quan trọng)
    # ------------------------------------
    - name: Restart Backend and Reload Nginx
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # THAM SỐ KHẮC PHỤC LỖI SSH HANDSHAKE
        key_algorithm: 'ssh-rsa'
        script: |
          # Vào thư mục Backend để kích hoạt lại venv (nếu có thay đổi requirements)
          cd /var/www/windshop/backend
          # Bắt buộc cài đặt lại libs nếu requirements.txt thay đổi
          /var/www/windshop/backend/venv/bin/pip install -r requirements.txt
          
          # Khởi động lại Gunicorn (Backend FastAPI)
          sudo systemctl restart windshop_backend
          
          # Reload Nginx để áp dụng các file tĩnh Frontend mới
          sudo systemctl reload nginx
          
          echo "Deployment và khởi động lại dịch vụ hoàn tất."